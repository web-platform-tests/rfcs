# RFC 149: Support reftest variants

## Summary

Currently, there is no support for [variants] for reftests. This RFC proposes
that we should support reftest [variants].

## Details

When writing reftests for anything that may have an argument the writer of the
test is limmited to either creating one large test that contains several
subtests within it, or creating several largely similar tests with minor
differences. As an example, consider the `<bdo>` element and the test created
in the [reftest tutorial]. To test both `dir="rtl"` and `dir="ltr"` for the
`<bdo>` element, two separate tests or one less descriptive test with both
variants must be created.

The proposal is to change the reftest manifest to allow for reftests to specify
variants via a `<meta name="variant" content="">` tag, as currently described in
the [variants] section of the documentation.

### Example

Again consider the [reftest tutorial] example of the `<bdo>` element. With
reftest variants, the test could look like the following:

```
<!DOCTYPE html>
<html class="reftest-wait">
<meta charset="utf-8">
<title>BDO element</title>
<link rel="help" href="https://html.spec.whatwg.org/#the-bdo-element">
<meta name="assert" content="BDO element's DIR content attribute renders correctly.">
<link rel="match" href="bdo-dir-ref.html">
<meta name="variant" content="?dir=rtl">
<meta name="variant" content="?dir=ltr">

<p>Test passes if displayed correctly.</p>
<bdo id="target">SAW</bdo>
<script>
  onload = () => {
    if (location.search) {
      let bdoTag = document.getElementById("target");
      let params = new URL(document.location).searchParams;
      bdoTag.dir = params.get("dir");
    }
    document.documentElement.removeAttribute('class');
  }
</script>
</html>
```

With reftest variants, the test reference could look like the following:

```
<!DOCTYPE html>
<html class="reftest-wait">
<meta charset="utf-8">
<title>BDO element reference</title>

<p>Test passes if displayed correctly.</p>
<p id="reference"></p>
<script>
  onload = () => {
    function addReferenceText(text) {
      const newtext = document.createTextNode(text);
      const p = document.getElementById("reference");
      p.appendChild(newtext);
    }

    if (location.search) {
      let params = new URL(document.location).searchParams;
      let dir = params.get("dir");
      if (dir == "ltr") {
        addReferenceText("SAW");
      } else if (dir == "rtl") {
        addReferenceText("WAS");
      } else {
        addReferenceText("Invalid `dir` argument");
      }
    } else {
      addReferenceText("No variant provided");
    }
    document.documentElement.removeAttribute('class');
  }
</script>
</html>
```

## Risks

This change could encourage reftest authors to create more tests and test
references that rely on [reftest-wait] and are generated by a script. It may be
harder to evaluate the expected behavior of a test when viewing the reference
for such tests.

[reftest tutorial]: https://web-platform-tests.org/writing-tests/reftest-tutorial.html#writing-the-test-file
[variants]: https://web-platform-tests.org/writing-tests/testharness.html#variants
[reftest-wait]: https://web-platform-tests.org/writing-tests/reftests.html#controlling-when-comparison-occurs
